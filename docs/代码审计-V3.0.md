# Serein V3.0 内核架构审计报告

**日期**: 2026-01-01  

---

## 执行摘要

### V2.0 状态评估

Serein V2.0 已实现大量现代操作系统特性，功能完善：

| 特性类别 | 实现状态 | 代码位置 |
|---------|---------|---------|
| Stride 调度 | [已完成] 完整实现 | `proc.c`, `sched.h` |
| 信号系统 | [已完成] 完整实现 | `proc.c`, `signal.h` |
| 权限系统 (UID/GID) | [已完成] 基础实现 | `proc.h`, `sysproc.c` |
| 进程组管理 | [已完成] 完整实现 | `proc.c`, `sysproc.c` |
| Copy-on-Write | [已完成] 完整实现 | `vm.c`, `kalloc.c` |
| Lazy Allocation | [已完成] 完整实现 | `vm.c`, `trap.c` |
| mmap/munmap | [已完成] 完整实现 | `sysfile.c`, `vm.c` |
| 非阻塞 I/O | [已完成] 完整实现 | `pipe.c`, `file.c` |
| 信号量 | [已完成] 完整实现 | `sem.c` |
| 共享内存 | [已完成] 完整实现 | `shm.c` |
| PID 哈希表 | [已完成] 完整实现 | `pid_hash.c` |
| 缓冲区分桶 | [已完成] 完整实现 | `bio.c` |
| FAT32 优化 | [已完成] 稀疏索引 + 分配提示 | `fat32.c` |

### 主要发现

1. **安全风险**: 整体较低，信号帧地址需从用户栈隔离。
2. **性能**: 嵌入式场景下足够，线性扫描可接受。
3. **缺口**: 主要是 I/O 多路复用 (poll) 和定时器 (alarm)。

---

## 第一部分: 关键风险

### 1.1 信号帧安全 (中)

**问题**: `check_signals()` 将信号帧地址存在 `p->sig_frame_addr`，但 `sigreturn` 从用户栈读取，可能被篡改。

**建议**:
```c
struct sigframe sig_frame_saved;  // 方案1: 内核副本
uint64 sig_frame_cookie;          // 方案2: 完整性校验
```

### 1.2 代码冗余 (低)

- `trap.c`: `mmap_handle_fault` 重复调用。
- `sysproc.c`: 残留调试 `printf`。

---

## 第二部分: 性能分析

> [!TIP]
> 当前嵌入式定位下，以下瓶颈无需立即修复。

1. **线性扫描**: `allocproc`, `wait`, `scheduler` 均为 O(N)。(N=50 时可忽略)
2. **大锁**: 文件表单一锁保护。(高并发下有争用)
3. **调度**: Stride 无锁扫描后需验证，可能有重复开销。(但避免了死锁)

---

## 第三部分: V3.0 功能升级

### core 1: I/O 多路复用 (Feature Complete)

**目标**: 实现 `poll()` 系统调用。

**实现**:
- `struct pollfd` 定义
- `sys_poll` 轮询逻辑
- 支持 pipe, socket, console 等设备

### core 2: 定时器 (Feature Complete)

**目标**: 实现 `alarm()` 和 `SIGALRM`。

**实现**:
- `proc.h`: 添加 `alarm_ticks`
- `timer_tick`: 检查到期并触发信号

### core 3: 文件控制 (Feature Complete)

**目标**: `fcntl()` 和 `O_CLOEXEC`。

**实现**:
- `F_DUPFD`, `F_GETFL`, `F_SETFL`
- `exec` 时自动关闭 `FD_CLOEXEC` 文件

---

## 第四部分: V3.0 实施记录

### 已完成任务

| 任务 | 状态 | 修改模块 |
|------|------|----------|
| 修复 trap.c 重复调用 | ✅ | `trap.c` |
| 清理调试打印 | ✅ | `sysproc.c` |
| 实现 alarm() | ✅ | `timer.c`, `sysproc.c` |
| 实现 poll() | ✅ | `sysfile.c` |
| 实现 fcntl() | ✅ | `sysfile.c` |
| 实现 O_CLOEXEC | ✅ | `exec.c` |
| 修复 copyinstr2 安全漏洞 | ✅ | `syscall.c` |

### 新增系统调用

| ID | 名称 | 描述 |
|----|------|------|
| 58 | `alarm` | 设置定时器 |
| 59 | `poll` | I/O 多路复用 |
| 60 | `fcntl` | 文件控制 |
| 61 | `chmod` | 权限修改 |
| 63 | `clone` | 线程创建 |

### 测试通过

- `usertests`: PASS
- `alarmtest`: PASS
- `polltest`: PASS
- `fcntltest`: PASS
- `threadtest`: PASS

---

## 结论

Serein V3.0 在 V2.0 基础上成功集成了 **poll**, **alarm**, **fcntl** 等关键 POSIX 特性，并修复了潜在安全问题。所有核心模块（调度、内存、FS）保持稳定，未做侵入式修改。

**版本状态**: **Ready for Release**




