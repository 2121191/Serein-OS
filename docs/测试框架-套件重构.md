# xv6 测试套件重构报告

**日期**: 2026-01-02  
**版本**: V3.0

---

## 背景

xv6 原本有 23 个独立的测试程序，分散在 UPROGS 中。每次编译都会生成这些二进制文件，占用文件系统空间，而且运行测试时需要逐个手动执行。这次重构把它们整合到 `usertests.c` 里，实现统一管理。

## 主要改动

### 1. 测试文件迁移

23 个测试文件移到 `xv6-user/tests/` 目录：

| 类别 | 测试文件 |
|------|----------|
| 信号/定时器 | alarmtest, sigtest, sigtest2 |
| 文件操作 | fcntltest, chmodtest, exttest |
| 进程/线程 | threadtest, pgtest, idtest |
| I/O | polltest, nbtest, testdev |
| 内存 | mincore_test, mmaptest, cowstress |
| IPC | semtest, semtest2, semstress, shmtest1, shmtest2, shmstress |
| 其他 | logtest, sysinfotest |

### 2. usertests.c 整合

用 `#include` 直接包含原始测试代码，避免重写：

```c
int verbose = 0;  // 全局标志

#include "tests/alarmtest.c"
#include "tests/fcntltest.c"
// ... 共 23 个

void alarmtest(char *s) {
    if(verbose) { 
        alarmtest_main(1, argv);
        return; 
    }
    // 简化版测试
}
```

每个测试文件的 `main` 改名为 `xxx_main`，避免符号冲突。

### 3. Makefile 清理

从 UPROGS 移除 23 个测试程序，只保留 `_consoletest`（需要交互输入）。

## 遇到的问题

### 宏冲突

`semstress.c` 和 `shmstress.c` 都定义了 `ITERATIONS` 和 `NPROCS`，编译报重定义错误。在 include 前加 `#undef` 解决：

```c
#undef ITERATIONS
#undef NPROCS
#include "tests/semstress.c"
```

### 函数名冲突

三个 stress 测试都有同名内部函数，改名区分：
- `cowstress()` → `cowstress_run()`
- `semstress()` → `semstress_run()`
- `shmstress()` → `shmstress_run()`

### 共享内存 bug

测试过程中发现共享内存的引用计数有问题：`shmopen` 错误地增加了 ref，`shmunlink` 没有减少 ref，导致内存不释放。修改了 `kernel/shm.c` 的逻辑。

## 使用方法

```bash
usertests              # 运行所有测试
usertests alarmtest    # 运行单个测试
usertests -v alarmtest # verbose 模式，显示详细输出
consoletest            # 交互式测试，单独运行
```

## 结果

- usertests.c 从 2600 行增加到 3000 行
- UPROGS 从 53 个减少到 31 个
- 所有测试通过
