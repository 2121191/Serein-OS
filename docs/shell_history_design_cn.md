# Shell 命令历史功能设计文档

## 1. 概述
为 xv6 shell (`sh.c`) 增加 Bash 风格的命令历史记录功能，允许用户使用上下箭头键浏览和重复执行历史命令。

## 2. 核心组件

### 2.1 内核控制台驱动 (`kernel/console.c`)
- **功能**: 解析 ANSI 转义序列，识别方向键。
- **实现**:
    - 状态机解析 `ESC [ A` (上) 和 `ESC [ B` (下)。
    - 映射为特殊键值: `KEY_UP (0xE2)`, `KEY_DOWN (0xE3)`。

### 2.2 Shell 历史缓冲区 (`xv6-user/sh.c`)
- **数据结构**:
    - `history.commands`: 循环缓冲区，存储最近 16条命令。
    - `head/tail`: 读写指针。
    - `pos`: 当前浏览位置 (-1 表示当前输入行)。

### 2.3 交互逻辑
- **向上箭头 (↑)**:
    - 清楚当前行显示。
    - 获取上一条历史命令。
    - 打印命令并更新输入缓冲区。
- **向下箭头 (↓)**:
    - 获取下一条历史命令。
    - 如已在最新，清空行等待新输入。

## 3. 实现状态
- [x] 内核: 转义序列解析状态机
- [x] Shell: 历史记录数据结构
- [x] Shell: `getcmd` 函数改造
- [x] 验证: 功能测试通过

## 4. 改进记录
- **2026-01-01**: 
    - 初始实现。修复了 `sh.c` 中的重复代码和宏定义缺失问题。
    - **修复显示延迟**: 修改 `kernel/console.c`，在接收到 `KEY_UP`/`KEY_DOWN` 时立即唤醒读取进程，解决按键后界面无响应的问题。

