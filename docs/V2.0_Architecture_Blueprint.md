# xv6-k210 V2.0 æ¶æ„æ¼”è¿›è“å›¾ä¸å·¥ä½œè®¡åˆ’

> ğŸ“… å®¡è®¡æ—¥æœŸ: 2025-12-29  
> ğŸ¯ ç›®æ ‡: ä»"å¯ç”¨"è¿ˆå‘"é«˜æ€§èƒ½"

---

## ğŸ“Š å®¡è®¡æ‘˜è¦

### æƒŠå–œå‘ç° âœ¨

| ç‰¹æ€§ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **Copy-on-Write** | âœ… å·²å®ç° | `vm.c:uvmcopy()` + `PTE_COW` æ ‡è®° |
| **Lazy Allocation** | âœ… å·²å®ç° | `vm.c:lazy_alloc()` + trap å¤„ç† |
| **å¤§æ–‡ä»¶æ”¯æŒ** | âœ… FAT32 æ— é™åˆ¶ | æœ€å¤§ 4GB (FAT32 æ ‡å‡†) |
| **å¼•ç”¨è®¡æ•°** | âœ… å·²å®ç° | `kalloc.c:krefget/krefput` |

**ç»“è®º**: å†…å­˜ç®¡ç†å­ç³»ç»Ÿå·²è¾¾ç°ä»£æ°´å¹³ï¼Œ**æ— éœ€é¢å¤–ä¼˜åŒ–**ï¼

---

## ğŸ”´ å½“å‰æ€§èƒ½ç“¶é¢ˆ

### bcache å…¨å±€é”ç«äº‰

```c
// bio.c - å½“å‰è®¾è®¡
struct {
  struct spinlock lock;  // âŒ å…¨å±€é” = å¤šæ ¸ä¸²è¡ŒåŒ–
  struct buf buf[30];    // NBUF = MAXOPBLOCKS * 3
} bcache;
```

**å½±å“åˆ†æ**:
- æ¯æ¬¡ `bread()/bwrite()` éœ€è·å–å…¨å±€é”
- 2 CPU ç¯å¢ƒä¸‹ I/O ååé‡æŸå¤± 30-50%
- Shell å¯åŠ¨æ…¢çš„çœŸæ­£åŸå› : exec() åŠ è½½ ELF æ—¶ I/O ä¸²è¡ŒåŒ–

---

## ğŸ“‹ ç‰¹æ€§ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | ç‰¹æ€§ | éš¾åº¦ | æ”¶ç›Š |
|--------|------|------|------|
| **P0** | bcache ç¼–å·åˆ†åŒºé” | â­â­â­ | I/O åå 2-3x æå‡ |
| **P1** | mmap å†…å­˜æ˜ å°„æ–‡ä»¶ | â­â­â­â­â­ | é›¶æ‹·è´ I/O |
| P2 | Big Files | âœ… å·²æ»¡è¶³ | N/A |
| - | CoW Fork | âœ… å·²å®ç° | N/A |
| - | Lazy Allocation | âœ… å·²å®ç° | N/A |

---

## ğŸš€ V2.0 æ‰§è¡Œè®¡åˆ’

### æˆ˜ç•¥é€‰æ‹©: æ–‡ä»¶ç³»ç»Ÿä¼˜å…ˆ

**ç†ç”±**: å†…å­˜ç®¡ç†å·²å®Œå–„ï¼Œbcache é”æ˜¯æœ€å¤§ç“¶é¢ˆ

---

### Phase 2.0.1: bcache åˆ†åŒºé” (3-5 å¤©)

**ç›®æ ‡**: æ¶ˆé™¤å…¨å±€é”ç“¶é¢ˆ

**æ ¸å¿ƒæ”¹åŠ¨**:
```c
#define NBUCKET 13  // ç´ æ•°å‡å°‘å†²çª

struct bucket {
  struct spinlock lock;  // æ¯æ¡¶ç‹¬ç«‹é”
  struct buf head;
} bcache[NBUCKET];

#define BUCKET(blockno) (blockno % NBUCKET)
```

**ä¿®æ”¹æ–‡ä»¶**:
- `include/param.h` - æ·»åŠ  NBUCKET
- `include/buf.h` - æ·»åŠ  timestamp å­—æ®µ
- `bio.c` - é‡æ„ bget/brelse

**éªŒæ”¶æ ‡å‡†**:
- [ ] usertests å…¨éƒ¨é€šè¿‡
- [ ] å¹¶å‘æ–‡ä»¶è¯»å†™æ— æ­»é”
- [ ] ååé‡æå‡å¯æµ‹é‡

---

### Phase 2.0.2: mmap å®ç° (5-7 å¤©)

**ç›®æ ‡**: æ”¯æŒå†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œé›¶æ‹·è´ I/O

**æ–°å¢ API**:
```c
void *mmap(void *addr, size_t len, int prot, int flags, int fd, off_t off);
int munmap(void *addr, size_t len);
```

**æ ¸å¿ƒè®¾è®¡**:
```c
struct vma {
  uint64 addr, len;
  int prot, flags;
  struct file *f;
  uint64 offset;
  int valid;
};

// proc.h
struct vma vmas[MAX_VMA];  // MAX_VMA = 16
```

**ä¿®æ”¹æ–‡ä»¶**:
- `include/proc.h` - æ·»åŠ  VMA ç»“æ„
- `sysfile.c` - ç³»ç»Ÿè°ƒç”¨å®ç°
- `vm.c` - mmap ç¼ºé¡µå¤„ç†
- `trap.c` - æ‰©å±•ç¼ºé¡µè·¯å¾„

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç®€å• mmap è¯»å†™æµ‹è¯•é€šè¿‡
- [ ] MAP\_PRIVATE CoW æ”¯æŒ
- [ ] munmap æ­£ç¡®é‡Šæ”¾èµ„æº

---

## ğŸ“Š ç³»ç»Ÿå‚æ•°è°ƒæ•´å»ºè®®

| å‚æ•° | å½“å‰ | å»ºè®® | ç†ç”± |
|------|------|------|------|
| NBUF | 30 | 60 | å¢åŠ ç¼“å­˜å®¹é‡ |
| NBUCKET | - | 13 | åˆ†åŒºé”æ¡¶æ•° |
| MAX_VMA | - | 16 | æ¯è¿›ç¨‹æ˜ å°„æ•° |

---

## ğŸ“ å®Œæ•´æŠ€æœ¯æ–‡æ¡£

è¯¦ç»†å®ç°æ–¹æ¡ˆè¯·å‚é˜…:  
[implementation_plan.md](file:///home/wzh/.gemini/antigravity/brain/a6b84adb-730d-43a5-bb74-d93ac3649302/implementation_plan.md)

---

*Generated by xv6-k210 Chief Architect*
