# 用户使用-内存管理-vmstat工具

## 1. 工作概述 
在实现了 Lazy Allocation 与 COW 等高级内存管理机制后，我们发现我们目前的内核缺少一个能从用户态直观观测其效果的工具。为此，我们新增了一个用户态命令 `vmstat`，用于实时监控或一键演示内核的内存状态。

---

## 2. 问题发现 
- **效果难验证**：Lazy Allocation（`sbrk` 后不耗内存、touch 后才耗）和 COW（`fork` 后不耗内存、写时才耗）这类优化，如果没有一个直观的观测工具，很难向他人（例如比赛评委、助教）清晰展示其效果。
- **调试不便**：缺少一个快速查看系统整体内存使用情况的用户态命令，不便于做性能分析或问题排查。

---

## 3. 解决方案 (Solution)
### 3.1 演示模式：一键展示 Lazy Alloc 与 COW
当用户直接执行 `vmstat`（不带任何参数）时，程序会进入 `test_lazy_and_cow()` 演示流程：

1. **初始状态**：打印当前内存占用。
2. **Lazy Allocation 演示**：
   - 调用 `sbrk()` 申请多页内存，并立即打印内存状态。预期 `freemem` 基本不变。
   - 逐页“touch”（写入数据），再打印内存状态。预期 `freemem` 显著下降。
3. **COW 演示**：
   - 调用 `fork()` 创建子进程，并立即打印内存状态。预期 `freemem` 基本不变（父子共享页）。
   - 子进程修改共享页面，父进程 `wait()` 回收后，再次打印内存状态。预期 `freemem` 下降（因为发生了写时复制，消耗了新物理页）。

该模式通过前后对比，清晰地展示了两种高级内存管理机制的行为。


### 3.3 内核信息获取：依赖 sysinfo
`vmstat` 的所有数据均来自 `sysinfo` 系统调用返回的 `struct sysinfo`，该结构体在此前的开发中已被扩展，包含了 `freemem`、`nproc`、`cow_pages` 等字段，为 `vmstat` 提供了数据来源。

---

## 4. 小结 (Conclusion)
综上，`vmstat` 是一个为展示本项目高级内存管理特性而专门开发的用户态工具。它通过“演示”与“监控”两种模式，将原先在内核中“不可见”的 Lazy Allocation 与 COW 行为，以一种直观、可量化的方式呈现出来，极大地提升了系统的可观测性与可演示性。
